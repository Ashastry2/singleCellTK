---
title: "Marker Selection using Seurat"
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
  object: object
output:
  html_document:
    number_sections: yes
    toc: yes
    code_folding: hide
---
## Differential Expression (Clusters)
Gene markers that are differentially expressed between the previously computed "*(`r selectedOption`)*" are identified using the Wilcoxon Rank Sum test. Criteria for the identification of these marker genes required them to be detected at a minimum percentage of 25% in either of the two groups of cells (each cluster against all others), and additionally they show 25% log-fold expression difference between two groups. 

```{r, echo = TRUE}
data <- seuratFindMarkers(data, allGroup = selectedOption, minPCT = 0.25, threshUse = 0.25, verbose = FALSE)
data.markers <- metadata(data)$seuratMarkers
#numTotalMarkersQ <- nrow(data.markers[data.markers$p_val_adj < 0.05, ])

write.csv(data.markers, file = paste0(outputPath, "DEGTableClusters", "-", gsub(" ", "_", Sys.Date()), ".csv"), row.names = FALSE)
```

### Gene Plots of Top Markers by Clusters {.tabset .tabset-fade}
Gene plots for the top marker genes in each of the identified clusters are visualized below through a feature plot, ridge plot, violin plot, dot plot and a heatmap plot.

#### Feature Plot {.tabset .tabset-fade .tabset-pills -}
A *feature plot* visualizes the *expression level* of a particular *gene marker in all cells of the data* on a *UMAP* plot. The *feature plots* of the *top 10 marker genes* across all *clusters* are visualized below:

```{r}
figHeight <- 10 * 1.8
```

```{r, echo = TRUE, results = "asis", fig.height = figHeight, fig.width = 9}
template <- "##### %s {.tabset .tabset-fade -}
"
template_inside <- "###### %s {-}
"
space <- "

"

top10 <- data.frame(data.markers %>% group_by(cluster1) %>% top_n(10, avg_log2FC))
numClusters <- length(unique(data.markers$cluster1))
for (currentCluster in 0:(numClusters-1)) {
  cat(sprintf(template, paste0("Cluster ", currentCluster)))
  selectedFeatures <- top10[top10$cluster1 == unique(data.markers$cluster1)[currentCluster+1], ]$gene.id
  plots <- seuratGenePlot(data, plotType = "feature", features = selectedFeatures, groupVariable = selectedOption, ncol = 1, cols = c("grey", "blue"))
  p <- singleCellTK:::.ggSCTKTheme(patchwork::wrap_plots(plots, ncol = 2))
  print(p)
  cat(space)
}
```


#### Ridge Plot {.tabset .tabset-fade .tabset-pills -}
A *ridge plot* visualizes the *expression level* of a particular *gene marker in all cells of the data* separated by *clusters* in the form of ridges. The *ridge plots** of the *top 10 marker genes* across all *clusters* are visualized below:

```{r, echo = TRUE, results = "asis", fig.height =figHeight, fig.width = 9, message=FALSE}
template <- "##### %s {.tabset .tabset-fade -}
"
template_inside <- "###### %s {-}
"
space <- "

"

top10 <- data.frame(data.markers %>% group_by(cluster1) %>% top_n(10, avg_log2FC))
numClusters <- length(unique(data.markers$cluster1))
for (currentCluster in 0:(numClusters-1)) {
  cat(sprintf(template, paste0("Cluster ", currentCluster)))
  selectedFeatures <- top10[top10$cluster1 == unique(data.markers$cluster1)[currentCluster+1], ]$gene.id
  plots <- seuratGenePlot(data, plotType = "ridge", features = selectedFeatures, groupVariable = selectedOption, ncol = 1, cols = c("grey", "blue"))
  p <- singleCellTK:::.ggSCTKTheme(patchwork::wrap_plots(plots, ncol = 2))
  print(p)
  cat(space)
}
```

#### Violin Plot {.tabset .tabset-fade .tabset-pills -}
A *violin plot* visualizes the *expression level* of a particular *gene marker in all cells of the data* separated by *clusters*. The *violin plots* of the *top 10 marker genes* separated across all *clusters* are visualized below:

```{r, echo = TRUE, results = "asis", fig.height =figHeight, fig.width = 9, message=FALSE}
template <- "##### %s {.tabset .tabset-fade -}
"
template_inside <- "###### %s {-}
"
space <- "

"

top10 <- data.frame(data.markers %>% group_by(cluster1) %>% top_n(10, avg_log2FC))
numClusters <- length(unique(data.markers$cluster1))
for (currentCluster in 0:(numClusters-1)) {
  cat(sprintf(template, paste0("Cluster ", currentCluster)))
  selectedFeatures <- top10[top10$cluster1 == unique(data.markers$cluster1)[currentCluster+1], ]$gene.id
  plots <- seuratGenePlot(data, plotType = "violin", features = selectedFeatures, groupVariable = selectedOption, ncol = 1, cols = c("grey", "blue"))
  p <- singleCellTK:::.ggSCTKTheme(patchwork::wrap_plots(plots, ncol = 2))
  print(p)
  cat(space)
}
```


#### Dot Plot {-}
A *dot plot* visualizes the *change in the expression levels* of a particular *gene marker in all cells of the data* separated by *clusters* in the form of dots where the color of the dots indicate the expression level of that gene in a cluster and the size of the dot indicates the total percentage of the cells in that cluster.

```{r, fig.width=15, fig.height=8}
top9 <- data.frame(data.markers %>% group_by(cluster1) %>% top_n(9, avg_log2FC))
top9 <- top9$gene.id
seuratGenePlot(data, plotType = "dot", features = top9, groupVariable = selectedOption, ncol = 1, cols = c("grey", "blue")) + theme(axis.text.x = element_text(angle = 90, size = 7), legend.text = element_text(size = 8), legend.key.size = unit(0.4, "cm"), legend.position = "top")
```

#### Heatmap Plot {-}

```{r, fig.width=15, fig.height=15}
top9 <- data.frame(data.markers %>% group_by(cluster1) %>% top_n(9, avg_log2FC))
top9 <- top9$gene.id
seuratGenePlot(data, plotType = "heatmap", features = top9, groupVariable = selectedOption, ncol = 1, cols = c("grey", "blue")) + theme(axis.text.y = element_text(size = 8), legend.text = element_text(size = 8), legend.key.size = unit(0.5, "cm"), legend.position = "top")
```

### Table of Top Markers by Cluster
The list of all top genes for each clusters are saved as **top_genes_cluster.csv** which is available within the working directory and the list of top *10* genes for each clusters are listed below:

```{r, echo = FALSE, results='asis'}
# Top genes table
top5 <- data.frame(data.markers %>% group_by(cluster1) %>% top_n(5, avg_log2FC))
top10 <- data.frame(data.markers %>% group_by(cluster1) %>% top_n(10, avg_log2FC))
top_all <- data.frame(data.markers %>% group_by(cluster1))

write.csv(top10, file = paste0(outputPath, "DEGTableClustersTop10", "-", gsub(" ", "_", Sys.Date()), ".csv"), row.names = FALSE)

colNames<-colnames(top10)
kable(top10, style = 'html', row.names = FALSE) %>%
  kable_styling(bootstrap_options = "striped") %>%
  scroll_box(width = "100%", height = "500px")
```
