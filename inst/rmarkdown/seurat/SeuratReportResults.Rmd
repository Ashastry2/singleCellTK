---
title: "Single Cell Analysis with Seurat using singleCellTK Package"
author: "`r params$authors`"
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
  subtitle: !r NULL
  authors: !r NULL
  sce: !r NULL
  biological.group: !r NULL
  phenotype.groups: !r NULL
  selected.markers: !r NULL
  clustering.resolution: 0.8
  variable.features: 2000
  pc.count: 50
  outputPath: !r NULL
  showSession: TRUE
  pdf: TRUE
  jackStraw: FALSE
  data: !r NULL
  sigPC: 10
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    theme: cosmo
    code_folding: hide
    self_contained: false
  pdf_document:
    toc: yes
subtitle: "`r params$subtitle`"
editor_options:
  chunk_output_type: console
---

```{r parameters_setup, include = TRUE, message=FALSE, warning=FALSE, echo=FALSE}
#Loading required libraries
library(Seurat)
library(dplyr)
library(cowplot)
library(RColorBrewer)
library(ggplot2)
library(knitr)
library(kableExtra)
library(SingleCellExperiment)
library(scater)
library(gridExtra)
library(grid)
library(ggpubr)
library(patchwork)
library(singleCellTK)

#Setting up parameters and loading data
group <- params$biological.group
selected_phenotypes <- params$phenotype.groups
Pre_selected_markers <- params$selected.markers
seurat.selected.resolution <- as.numeric(params$clustering.resolution)
seurat.selected.features.numbers <- as.numeric(params$variable.features)
initial.PC.numbers <- as.numeric(params$pc.count)
sampleNames <- unique(colData(data)[[group]])
outputPath <- params$outputPath
showSession <- params$showSession
pdf <- params$pdf
data <- params$data
significant_PC <- params$sigPC

numCells <- ncol(data)
numFeatures <- nrow(data)
numSamples <- length(sampleNames)

# Knitr Global Options
dev <- ifelse(isTRUE(pdf), c("png"), c("png", "pdf"))
opts_chunk$set(
  echo = TRUE,
  cache = FALSE,
  cache.lazy = FALSE,
  cache.comments = FALSE,
  fig.align = "center",
  fig.keep = "all",
  dev = dev,
  warning = FALSE
)
```


# Seurat Results

## Selected Resolution {.tabset .tabset-fade}
A final resolution of **`r seurat.selected.resolution`** was selected for downstream clustering that better reflects the input data.

<!-- Compute -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
resClusteringSelectedResolution <- knitr::knit_child('reportSeuratFindClusters.Rmd', quiet = TRUE)
cat(resClusteringSelectedResolution, sep = '\n')
```

### tSNE {.tabset .tabset-pills -}
tSNE (Non-linear Dimensional Reduction) is a dimensionality reduction technique that places cells with similar local neighborhoods in high-dimensional space together in low-dimensional space. Using default parameters, a final resolution of **`r seurat.selected.resolution`** and **`r significant_PC`** principal components were chosen to better reflect the data, visualized in the tSNE plot below:

<!-- Compute -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
dr <- "tsne"
resTSNE <- knitr::knit_child('reportSeuratUT.Rmd', quiet = TRUE)
cat(resTSNE, sep = '\n')
```
#### Clusters {-}
Seurat clusters cells and assigned a cluster label to each cell. The following plot is the tSNE representation of the clustering results, colored by the cluster labels.

```{r Seurat tsne clusters 0.6}
useReduction <- "tsne"
showLegend <- TRUE
groupBy <- NULL
splitBy <- NULL
```

<!-- Reduction Plot -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
res <- knitr::knit_child('reportSeuratReductionPlot.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```

> The data was clustered using the *`r significant_PC`* principal components previously computed using the community detection based *louvain* algorithm. Using this method, *13* clusters were identified by using a resolution of *0.8*. 

#### Samples {-}
The clustering pattern above determined to hold the true dimensionality of the dataset was grouped by sample (color) to visualize sample clusters.

```{r}
useReduction <- "tsne"
showLegend <- TRUE
groupBy <- group
splitBy <- NULL
```

<!-- Reduction Plot -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
res <- knitr::knit_child('reportSeuratReductionPlot.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```

> The data was clustered using the *`r significant_PC`* principal components previously computed using the community detection based *louvain* algorithm. Using this method, *13* clusters were identified by using a resolution of *0.8*. 

#### Sample separated {-}
Seurat clusters cells and assigned a cluster label to each cell. The following plot is the tSNE representation of the clustering results, split by each samples.

```{r}
useReduction <- "tsne"
showLegend <- TRUE
groupBy <- NULL
splitBy <- group
```

<!-- Reduction Plot -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
res <- knitr::knit_child('reportSeuratReductionPlot.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```


```{r Seurat tsne samples separated 0.6 phenotypes}
tSNE_coloredby_phenotype <- list()
for (i in 1:length(selected_phenotypes)){
  useReduction <- "tsne"
  showLegend <- TRUE
  groupBy <- selected_phenotypes[i]
  splitBy <- NULL

  tSNE_coloredby_phenotype[[i]] <- knitr::knit_child('reportSeuratReductionPlot.Rmd', quiet = TRUE)
}
  
```

```{r Seurat tsne samples separated 0.6 phenotypes plot, results='asis', echo = FALSE}
for (i in 1:length(selected_phenotypes)){
  cat('\n\n#### Phenotype variable:  `', selected_phenotypes[i], '` {-} \n\n')
  cat(tSNE_coloredby_phenotype[[i]], sep = '\n')
}

```

> The data was clustered using the *`r significant_PC`* principal components previously computed using the community detection based *louvain* algorithm. Using this method, *13* clusters were identified by using a resolution of *0.8*. 

### UMAP {.tabset .tabset-pills -}
The uniform manifold approximation and projection(UMAP) is another dimension reduction techniques to visualize the cell clusters in a low-dimensional space. Using default parameters, a final resolution of **`r seurat.selected.resolution`** and **`r significant_PC`** PCs was chosen to better reflect the data, visualized in the following UMAP.

```{r Seurat UMAP selected resolution}
dr <- "umap"
```

<!-- UT -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
res <- knitr::knit_child('reportSeuratUT.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```


#### Clusters {-}
Seurat clusters cells and assigned a cluster label to each cell. The following plot is the UMAP representation of the clustering results, colored by the cluster labels.
```{r}
useReduction <- "umap"
showLegend <- TRUE
groupBy <- NULL
splitBy <- NULL
```

<!-- Reduction Plot -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
res <- knitr::knit_child('reportSeuratReductionPlot.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```

> The data was clustered using the *`r significant_PC`* principal components previously computed using the community detection based *louvain* algorithm. Using this method, *13* clusters were identified by using a resolution of *0.8*. 

#### Samples {-}
Seurat clusters cells and assigned a cluster label to each cell. The following plot is the UMAP representation of the clustering results, colored by the sample labels. 
```{r}
useReduction <- "umap"
showLegend <- TRUE
groupBy <- group
splitBy <- NULL
```

<!-- Reduction Plot -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
res <- knitr::knit_child('reportSeuratReductionPlot.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```

> The data was clustered using the *`r significant_PC`* principal components previously computed using the community detection based *louvain* algorithm. Using this method, *13* clusters were identified by using a resolution of *0.8*. 

#### Sample separated {-}
Seurat clusters cells and assigned a cluster label to each cell. The following plot is the UMAP representation of the clustering results, split by each samples.

```{r}
useReduction <- "umap"
showLegend <- TRUE
groupBy <- NULL
splitBy <- group
```

<!-- Reduction Plot -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
res <- knitr::knit_child('reportSeuratReductionPlot.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```


```{r Seurat umap samples separated phenotype}
UMAP_coloredby_phenotype <- list()
for (i in 1:length(selected_phenotypes)){
    useReduction <- "umap"
    showLegend <- TRUE
    groupBy <- selected_phenotypes[i]
    splitBy <- NULL

  UMAP_coloredby_phenotype[[i]] <- knitr::knit_child('reportSeuratReductionPlot.Rmd', quiet = TRUE)
}
  
```

```{r Seurat umap samples separated phenotype plots, results='asis'}
for (i in 1:length(selected_phenotypes)){
  cat('\n\n#### Phenotype variable:  `', selected_phenotypes[i], '` {-} \n\n')
  cat(UMAP_coloredby_phenotype[[i]], sep = '\n')
}

```

> The data was clustered using the *`r significant_PC`* principal components previously computed using the community detection based *louvain* algorithm. Using this method, *13* clusters were identified by using a resolution of *0.8*. 

<!-- Pre-selected Markers -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
res <- knitr::knit_child('reportSeuratGenePlot.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```

<!-- Marker Selection (Clusters) -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
selectedOption <- paste0("Seurat_louvain_Resolution", seurat.selected.resolution)
res <- knitr::knit_child('reportSeuratMarkerSelection.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```

<!-- Marker Selection (Group) -->
```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
selectedOption <- group
res <- knitr::knit_child('reportSeuratMarkerSelection.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```

# Session Information
```{r session, eval = showSession, echo = showSession}
sessionInfo()
```

