---
title: "Dimensionality Reduction using Seurat"
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
  object: object
output:
  html_document:
    number_sections: yes
    toc: yes
    code_folding: hide
---
## PCA {.tabset .tabset-fade}
To reduce the adverse effects of the inherent technical noise in single-cell data on downstream clustering, reduced dimensions are computed where each dimension represents a set of correlated features. However, an important task is to select the number of components that should be utilized by the downstream methods. To select the number of principal components that should be used in the downstream analysis, JackStraw plot and Elbow plot visualized below provide convenience in the selection of the significant components that contain most of the variability.  

```{r Seurat PCAs, JackStraw and Elbow plot, warning=FALSE, eval = runDimRed}
pcaParams <- list(
  inSCE = data,
  nPCs = initial.PC.numbers,
  verbose = FALSE)
data <- do.call("seuratPCA", pcaParams)

```

```{r, warning=FALSE, eval = plotJackStraw}
jackStrawParams <- list(
  inSCE = data,
  useAssay = "seuratScaledData",
  dims = initial.PC.numbers,
  numReplicate = 100,
  propFreq = 0.025
)
data <- do.call("seuratComputeJackStraw", jackStrawParams)
```

```{r, results='asis', include=plotHeatmaps, eval= plotElbowPlot}
cat("### Elbow Plot {-}")
cat("Elbow plot is plotted between the principal components (x-axis) and their standard deviation (y-axis), where a clear elbow between the components highlights the cut-off for the no. of components that should be selected as significant for downstream analysis.")
```

```{r Seurat PCAs, Elbow Plot, warning=FALSE, eval=plotElbowPlot}
ElbowPlot <- seuratElbowPlot(
  inSCE = data,
  ndims = initial.PC.numbers,
  interactive = FALSE
)
ElbowPlot
```

```{r, results='asis', include=plotHeatmaps, eval= plotElbowPlot}
cat("> PCA was applied to the scaled subset matrix that contained the *2000* top most variable genes to transform the data into reduced dimensions for clustering in the downstream analysis. Significant principal components will show a strong enrichment of genes with low p-values from the JackStraw plot or PC cutoff could also be determined roughly by looking at where a clear elbow is depicted in the elbow plot. The first *`r 20`* components were selected based on the JackStraw *P-value > 0.01* as the cutoff. These *`r 20`* principal components were determined to hold the true dimensionality of the dataset and will be used in the subsequent clustering analysis.")
```

```{r, results='asis', include=plotHeatmaps, eval= plotJackStraw}
cat("### JackStraw Plot {-}")
cat("JackStraw computes significance values for all genes in all principal components and plots these genes as a QQ-plot for each component and compares them with the uniform distribution (shown in dotted line). Overall p-values are also computed for each component, where statistically significant principal components can be selected for downstream analysis. Visually, components that lie above the dotted uniform distribution line should be selected.")
```

```{r Seurat PCAs, JackStraw Plot, warning=FALSE, eval=plotJackStraw}
JackStrawPlot <- seuratJackStrawPlot(
  inSCE = data,
  dims = initial.PC.numbers,
  xmax = 0.05) + guides(col = guide_legend(ncol = 1)) + theme(
    legend.text = element_text(size = 6), legend.key.size = unit(0.2, "cm"))
JackStrawPlot
```

```{r Seurat Post PCA calculation, warning=FALSE, eval= plotJackStraw}
if(!is.null(metadata(data)$seurat$obj@reductions$pca@jackstraw)){
  PC_Matrix <- metadata(data)$seurat$obj@reductions$pca@jackstraw@overall.p.values
  
  significant_PC <- which.min(PC_Matrix[,2] < 0.01) - 1
if (!exists("significant_PC") || significant_PC == 0){
  significant_PC <- initial.PC.numbers
  }
}else{
  significant_PC <- initial.PC.numbers
}
```

```{r}
PC.separated.height <- 3.5 * ceiling(initial.PC.numbers/3)
```

```{r, include=FALSE}
pcaParams$inSCE <- NULL
pcaParams$significant_PC <- significant_PC
metadata(data)$seurat$sctk$report$pcaParams <- pcaParams
```

```{r, results='asis', include=plotHeatmaps, eval= plotJackStraw}
cat("> PCA was applied to the scaled subset matrix that contained the *2000* top most variable genes to transform the data into reduced dimensions for clustering in the downstream analysis. Significant principal components will show a strong enrichment of genes with low p-values from the JackStraw plot or PC cutoff could also be determined roughly by looking at where a clear elbow is depicted in the elbow plot. The first *`r significant_PC`* components were selected based on the JackStraw *P-value > 0.01* as the cutoff. These *`r significant_PC`* principal components were determined to hold the true dimensionality of the dataset and will be used in the subsequent clustering analysis.")
```

```{r, results='asis', include=plotHeatmaps, eval= plotHeatmaps}
cat("### PC Heatmap {-}")
cat("Heatmaps are plotted for each component that highlight the primary sources of heterogeneity in terms of features in the data. Both cells and features are ordered according to their PCA scores and this heatmap can be utilized to explore highly correlated feature sets in the data.")
```

```{r Seurat PC Heatmap, fig.height = PC.separated.height, fig.width = 15, warning=FALSE, eval = plotHeatmaps}
pcHeatmapParams <- list(
  inSCE = data,
  useAssay = "seuratScaledData",
  useReduction = "pca",
  dims = initial.PC.numbers,
  balanced = TRUE,
  ncol = 4,
  fast = FALSE
)
heatmap <- do.call("seuratComputeHeatmap", pcHeatmapParams)  
heatmap
```
```{r, include=FALSE, eval = plotHeatmaps}
pcHeatmapParams$inSCE <- NULL
metadata(data)$seurat$plots$heatmap <- pcHeatmapParams
```

```{r, results='asis', include=plotHeatmaps, eval= plotHeatmaps}
cat("> PCA was applied to the scaled subset matrix that contained the *2000* top most variable genes to transform the data into reduced dimensions for clustering in the downstream analysis. Significant principal components will show a strong enrichment of genes with low p-values from the JackStraw plot or PC cutoff could also be determined roughly by looking at where a clear elbow is depicted in the elbow plot. The first *`r significant_PC`* components were selected based on the JackStraw *P-value > 0.01* as the cutoff. These *`r significant_PC`* principal components were determined to hold the true dimensionality of the dataset and will be used in the subsequent clustering analysis.")
```
