---
title: "Batch Correction on SingleCellExperiment Object"
author: "Yichen Wang"
---

## Introduction

For this section, we wrapped 12 methods into functions that perform batch effect correction on an SingleCellExperiment (SCE) object and return the input SCE object with a corrected matrix updated in-place.
Here is a table for the method names, citations, and corresponding wrapper functions:

<table>
  <tr>
    <th>Method</th>
    <th>Citation</th>
    <th>Function</th>
  </tr>
  <tr>
    <td>BBKNN</td>
    <td>Pola≈Ñski, Krzysztof and et al., 2019</td>
    <td><a href="../reference/runBBKNN.html">runBBKNN()</a></td>
  </tr>
  <tr>
    <td>ComBat</td>
    <td>Yuqing Zhang and et al., 2018</td>
    <td><a href="../reference/runComBat.html">runComBat()</a></td>
  </tr>
  <tr>
    <td>FastMNN</td>
    <td>Aaron Lun, 2018</td>
    <td><a href="../reference/runFastMNN.html">runFastMNN()</a></td>
  </tr>
  <tr>
    <td>MNN</td>
    <td>Laleh Haghverdi, 2018</td>
    <td><a href="../reference/runMNNCorrect.html">runMNNCorrect()</a></td>
  </tr>
  <tr>
    <td>Harmony</td>
    <td>Ilya Korsunsky and et al., 2019</td>
    <td><a href="../reference/runHarmony.html">runHarmony()</a></td>
  </tr>
  <tr>
    <td>LIGER</td>
    <td>Joshua Welch, et al., 2018</td>
    <td><a href="../reference/runLIGER.html">runLIGER()</a></td>
  </tr>
  <tr>
    <td>Limma</td>
    <td>Gordon K Smyth, et al., 2003</td>
    <td><a href="../reference/runLimmaBC.html">runLimmaBC()</a></td>
  </tr>
  <tr>
    <td>Scanorama</td>
    <td>Brian Hie et al, 2019</td>
    <td><a href="../reference/runSCANORAMA.html">runSCANORAMA()</a></td>
  </tr>
  <tr>
    <td>scGen</td>
    <td>Mohammad Lotfollah et al., 2019</td>
    <td><a href="../reference/runSCGEN.html">runSCGEN()</a></td>
  </tr>
  <tr>
    <td>scMerge</td>
    <td>Yingxin Lin et al., 2019</td>
    <td><a href="../reference/runSCMerge.html">runSCMerge()</a></td>
  </tr>
  <tr>
    <td>Seurat Integration</td>
    <td>Tim Stuart et al., 2019</td>
    <td><a href="../reference/runSeurat3Integration.html">runSeurat3Integration()</a></td>
  </tr>
  <tr>
    <td>ZINBWaVE</td>
    <td>Davide Risso et al., 2018</td>
    <td><a href="../reference/runZINBWaVE.html">runZINBWaVE()</a></td>
  </tr>
</table>

## Prerequsites

- Latest `SingleCellTK` installed.
```{r install, eval=FALSE}
library(devtools)
install_github("compbiomed/singleCellTK@devel")
```
- An SCE object consists of multiple batches of datasets that introduce batch effect to be corrected.  
Here we present an example dataset that is combined from "pbmc3k" and "pbmc4k"
```{r prepareDataSet, message=FALSE, warning=FALSE, eval=FALSE}
library(singleCellTK)
pbmc3k <- importExampleData('pbmc3k')
pbmc3k
pbmc4k <- importExampleData('pbmc4k')
pbmc4k
# The way to combine multiple SCE objects varies depending on existing cell/gene metadata
isecGene <- intersect(rownames(pbmc3k), rownames(pbmc4k))
length(isecGene)
pbmc3k.isec <- pbmc3k[isecGene,]
pbmc4k.isec <- pbmc4k[isecGene,]
rowData(pbmc4k.isec) <- rowData(pbmc3k.isec)
sce.combine <- combineSCE(list(pbmc3k = pbmc3k.isec, pbmc4k = pbmc4k.isec))
sce.combine
sce.small <- sce.combine[sample(nrow(sce.combine), 500), sample(ncol(sce.combine), 500)]
# Many of the batch correction methods require log-normalized counts
sce.small <- scater_logNormCounts(inSCE = sce.small, logAssayName = 'logcounts', useAssay = 'counts')
```

## Run Batch Correction

The basic way to run a batch correction method from singleCellTK is to select a function for the corresponding method above, and input the SCE object, specify the assay to correct, and the batch annotation.

### BBKNN
BBKNN is a method
```{r bbknn, message=FALSE, warning=FALSE, eval=FALSE}
sce.small <- runBBKNN(inSCE = sce.small, useAssay = 'logcounts', batch = 'sample', reducedDimName = 'BBKNN')
sce.small
```