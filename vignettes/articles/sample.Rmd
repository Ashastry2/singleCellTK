---
title: "Normalization"
author: "Irzam Sarfraz"
output:
  html_document:
    toc: true
    toc_depth: 5
bibliography: references.bib
csl: ieee.csl.txt
---
```{r develSetting, include=FALSE}
doEval = TRUE
```
## Introduction
Data once uploaded and filtered through the preceding tabs can be normalized and
corrected for batch-effect. This guide particularly focuses on normalization of 
data for downstream analysis which can be achieved through various methods
and options integrated together in a single interface. Generally, users can use
one of the provided normalization methods integrated from other packages, or
use transformation options to manually normalize/scale data. Additionally, these
transformation options can be applied to normalized data as well depending upon
the type of the transformation.

````{=html}
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>

</style>
</head>
<body>

<h2>Workflow Guide</h2>

<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'interactive')" id="ia-button">Interactive Analysis</button>
  <button class="tablinks" onclick="openTab(event, 'console')">Console Analysis</button>
</div>

<div id="interactive" class="tabcontent">
  <p>
  
````

Normalization tab can be opened up by clicking on the <b>Normalization & Batch Correction</b> from the top menu and further selecting the <b>Normalization</b> sub-tab in the subsequent window as shown below.

<!-- ![](ui_screenshots/normalization/normalization_1_select_menu.png) -->

<!-- ![](ui_screenshots/normalization/normalization_2_overview_1.png) -->

The <b>Normalization</b> user-interface is divided into three parts, a) <b>Normalization Options</b>, b) <b>Assay Options</b>, and c) <b>Available Assays</b>.

<!-- ![](ui_screenshots/normalization/normalization_2_overview_2.png) -->

<h4> a) Normalization Options </h4>
In the <b>Normalization Options</b>, users can select a method for normalization from `Scater - CPM` or one of the methods from <b>Seurat</b> i.e. `LogNormalize`, `CLR` (Centered Log Ratio), `RC` (Relative Counts) and `SCTransform`. Users can also set a manual <b>Scaling Factor</b> (numeric value multiplied by the data values) and specify the <b>Assay Name</b> for the new `assay`. 

<!-- ![](ui_screenshots/normalization/normalization_3_seurat.png) -->

<!-- ![](ui_screenshots/normalization/normalization_4_cpm.png) -->

<h4> b) Assay Options </h4>
In addition to the normalization methods, manually implemented transformation methods can be used to perform different transformations on the data. These transformations include `Log Transform`, `log1p` and standard `Z-score`. 

<!-- ![](ui_screenshots/normalization/normalization_5_assay_options.png) -->

If trimming of an `assay` is required, 'Trim Assay' option can be enabled and lower/upper bound values can be set. The default value for upper and lower trim values is `10` and `-10` respectively.

<!-- ![](ui_screenshots/normalization/normalization_6_trim_assay.png) -->

<h4> c) Available Assays </h4>
The currently available 'assays' are listed in the 'Available Assays' window. Whenever a new `assay` is generated, the list is updated automatically.


````{=html}
  </p>
</div>

<div id="console" class="tabcontent">
The `singleCellTK` allows the users to run all normalization and
transformation methods on the input data by using a single `runNormalization`
function. The `runNormalization` function takes in input a 
`SingleCellExperiment` object and a series of parameters that define the
normalization/transformation options to run on the specified `assay`. The
output of this function is a `SingleCellExperiment` object which now contains
the normalized/transformed assay.

To use the function, input a `SingleCellExperiment` object that contains the data assay and specify the required parameters:
````

```{r, eval=FALSE}
sce <- runNormalization(
  inSCE = sce, 
  normalizationMethod = "RC", 
  useAssay = "counts", 
  outAssayName = "RCLogScaledCounts", 
  scale = TRUE, 
  transformation = "log2", 
  pseudocountsBeforeTransform = 1, 
  trim = c(10, -10))
```

<details>
  <summary>**Example**</summary>
```{r "normalization_console_example_1", message = FALSE, warning = FALSE}
  # Load singleCellTK & pbmc3k example data
  library(singleCellTK)
  sce <- importExampleData(dataset = "pbmc3k")
```
```{r "normalization_console_example_2", message=FALSE, warning = FALSE}
  # Perform normalization
  sce <- runNormalization(
    inSCE = sce,
    normalizationMethod = "RC",
    useAssay = "counts",
    outAssayName = "RCLogScaledCounts",
    scale = TRUE,
    transformation = "log2",
    pseudocountsBeforeTransform = 1, 
    trim = c(10, -10)
  )
```
</details> 

<details>
  <summary>**Parameters**</summary>
  The `runNormalization` function specifies the following parameters:

|Parameter|Description|
|---|---|
|inSCE|Input `SingleCellExperiment` object.|
|useAssay|Specify the input `assay` to use for normalization/transformation.|
|outAssayName|A `character` value indicating the name of the new output assay.|
|normalizationMethod|Specify a normalization method from `"LogNormalize"`, `"CLR"`, `"RC"`, `"SCTransform"`, `"logNormCounts"` or `"CPM"`. If no method is specified, normalization will not be performed.|
|scale|Logical value indicating if Z.Score scaling should be performed or not.|
|seuratScaleFactor|Specify the `scaleFactor` parameter if any of the **seurat** normalization method is selected.|
|transformation|Specify if a transformation should be applied to the input `assay` (if normalization is selected, this transformation is applied after normalization). Available transformation options include `"log2"`, `"log1p"`, `"sqrt"`.|
|pseudocountsBeforeNorm|A `numeric` value to add to the input `assay`  before performing normalization.|
|pseudocountsBeforeTransform|A `numeric` value to add to the input `assay` before performing a transformation.|
|trim|A `numeric(2)` vector that specifies the upper and the lower trim values between (exclusive) which the input `assay` should be trimmed.|
|verbose|A `logical` value indicating if informative/progress messages should be displayed on the console.|

  </details>

<details>
  <summary>**Individual Functions**</summary>
  While the `runNormalization` wrapper function can be used to perform all
  available normalization and transformation options, separate functions are also
  available for all of the included normalization methods. The following functions
  can be used for specific normalization methods:
 
 <style>
div.blue { background-color:#FFFFFF; border-radius: 5px; padding: 20px; margin-left: 10px;}
</style>
<div class = "blue">

<details>
    <summary>`LogNormalize`, `CLR` or `RC` from **Seurat** [@Butler2018][@Stuart2019] package:</summary> 

```{r, eval = FALSE}
  sce <- seuratNormalizeData(
          inSCE = sce,
          normalizationMethod = "CLR",
          useAssay = "counts",
          normAssayName = "CLRCounts",
          scaleFactor = 10000,
          verbose = TRUE
        )
```
The parameters to the above function include: <br><br>
`inSCE`: an input `SingleCellExperiment` object <br>
`normalizationMethod`: one of the options from "LogNormalize", "CLR" or "RC" <br>
`useAssay`: name of the assay to use for normalization <br>
`normAssayName`: name of the output normalized assay <br>
`scaleFactor`: a numeric value that represents the scaling factor <br>
`verbose`: a logical value indicating if progress should be printed <br><br>

 </details>
 
 <details>
    <summary>`SCTransform` from **Seurat** [@Hafemeister2019][@Butler2018][@Stuart2019]  package:</summary> 
```{r, eval = FALSE}
  sce <- seuratSCTransform(
          inSCE = sce,
          useAssay = "counts",
          normAssayName = "SCTCounts",
          verbose = TRUE
        )
```
  
  </details>
   
 <details>
    <summary>`logNormCounts` from **Scater** [@McCarthy2017] package:</summary> 
```{r, eval = FALSE}
  sce <- scaterlogNormCounts(
          inSCE = sce,
          useAssay = "counts",
          assayName = "logcounts")
```

</details>

<details>
    <summary>`CPM` from **Scater** [@McCarthy2017] package:</summary> 
```{r, eval = FALSE}
  sce <- scaterCPM(
          inSCE = sce,
          useAssay = "counts",
          assayName = "countsCPM")
```

</details>

 
  <details>
    <summary>Compute **Z-Score**:</summary> 
```{r, eval = FALSE}
  assay(sce, "countsZScore") <- computeZScore(assay(sce, "counts"))
```
  </details>
  
 <details>
    <summary>Matrix **trimming**:</summary> 
```{r, eval = FALSE}
  assay(sce, "countsTrimmed") <- trimCounts(assay(sce, "counts"), c(10, -10))
```
 </details>

</div>

</details> 


````{=html}
</div>
<script>
document.getElementById("ia-button").click();
function openTab(evt, tabName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";
}
</script>
   
</body>
````

## References
