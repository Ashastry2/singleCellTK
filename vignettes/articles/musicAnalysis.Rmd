---
title: "MuSiC analysis"
author: "Amulya Shastry"
date: "2022-10-28"
output: 
 html_document:
    toc: true
    toc_depth: 5
bibliography: references.bib
csl: ieee.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(singleCellTK)
library(SingleCellExperiment)
library(dplyr)
library(S4Vectors)
```

````{=html}
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
````



## Introduction

This section describes how to perform deconvolution of bulk data using single cell data with the package MuSiC under SingleCellTK

To view detailed instructions on how to use these methods, please select 'Interactive Analysis' for shiny application or 'Console Analysis' for using these methods on R console from the tabs below: <br>

## Workflow Guide

````{=html}
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'interactive')" id="ia-button">Interactive Analysis</button>
  <button class="tablinks" onclick="openTab(event, 'console')" id="console-button">Console Analysis</button>
</div>

<div id="interactive" class="tabcontent">
````

**Entry of The Panel**

From anywhere of the UI, the panel for marker finding can be accessed from the top navigation panel at the circled tab shown below.  


````{=html}
</details>
<br/>

</div>

<div id="console" class="tabcontent">
````

**Parameters**

For MuSic we provide two inputs a) SCE objct b) bulk RNA data. ALong with this, we choose the type of analysis we want to perform. Currently MuSiC under SCKT supports deconvolution using bulk dataset. 


```{R egCall, eval = FALSE}
sce <- <-runMusic(inSCE = sce,Mouse.bulkeset,
                  bulkData, 
                   analysisName = "NULL",
                   analysisType = c("EstCellProp","PreGroupedClustProp","SingleCellClust"), 
                   markers = NULL, 
                   clusters = "cellType", 
                   samples = "sampleID", 
                   preClusterlist = NULL,
                   DEmarkers = NULL,
                   groups = NULL, 
                   selectCt = NULL, 
                   cellSize = NULL, 
                   ctCov = FALSE, 
                   verbose = TRUE,
                   iterMax = 1000, 
                   nu = 1e-04,
                   eps = 0.01,
                   centered = FALSE,
                   normalize = FALSE,
                   nonZero = TRUE )
```

Here `inSCE` and `bulkData` are important for deconolution along with `analysisName` which is used to store the results and access them for plotting, `analysisType` defines one of the three music functions estimate cell type proportions, and estimate cell type proportions with pre-grouping of cells which has two steps i) Cluster single cell data ii) estimate bulk type proprotions.
For estimating cell type proportions with pre-grouping of the cells, `DEmarkers` and `preClusterlist` is necessary. 

The returned SCE object will contain the results in the `metadata` slot along with the analysisType 


**Example**


```{R example, eval = FALSE}
library(singleCellTK)
sce <- importExampleData("mouse.sce.rda")
bulk <-importExampleData("mouse_bulk.rda")


```


```{r EstCellProp, eval = FALSE}

# Estimation of cell type proportions
sce <-runMusic(inSCE = sce,bulkData = bulk,analysisType ="EstCellProp", analysisName = "testEstCellProp")

```


```{R import_prep, include=FALSE}
library(singleCellTK)
sce <- R.filesets::loadRDS(file = "/Users/amulyashastry/Documents/Code/R/Rotation_campbell/Music_wrapper/AshastrySingleCellTk/singleCellTK/data/new_sce_with_music_basis.rds")
```


```{R }
source("../../R/plotMusicResults.R")
library(singleCellTK)
library(SingleCellExperiment)
library(dplyr)
library(S4Vectors)
plotMusicResults(sce,analysisType ="EstCellProp", analysisName = "testEstCellProp",useAssay = "Est.prop.allgene")

```

````{=html}
</details>
<br/>
````


````{=html} 
</div>
<script>
document.getElementById("ia-button").click();
</script>
</body>
````







